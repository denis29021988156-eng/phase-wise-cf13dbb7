# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –ø–æ –ø–µ—Ä–µ–Ω–æ—Å—É —Å–æ–±—ã—Ç–∏–π

## –û–±–∑–æ—Ä

AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å —Å–æ–±—ã—Ç–∏—è, —É—á–∏—Ç—ã–≤–∞—è:
- –§–∞–∑—É –º–µ–Ω—Å—Ç—Ä—É–∞–ª—å–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
- –ü–ª–æ—Ç–Ω–æ—Å—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
- –ù–µ–¥–∞–≤–Ω–∏–µ –ª–æ–≥–∏ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏—è

## üìã –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
‚úÖ **–¢–∞–±–ª–∏—Ü–∞ `event_move_suggestions`** - —Ö—Ä–∞–Ω–∏—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è AI –ø–æ –ø–µ—Ä–µ–Ω–æ—Å—É
- –°–æ–∑–¥–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ –º–∏–≥—Ä–∞—Ü–∏—é
- –í–∫–ª—é—á–∞–µ—Ç RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### 2. Edge Functions

#### `ai-week-planner` 
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞ –Ω–µ–¥–µ–ª—é –≤–ø–µ—Ä–µ–¥
- **–ó–∞–ø—É—Å–∫**: –ß–µ—Ä–µ–∑ cron (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ)
- **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç**:
  - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–±—ã—Ç–∏—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  - –ù–∞—Ö–æ–¥–∏—Ç –¥–Ω–∏ —Å –ø–µ—Ä–µ–≥—Ä—É–∑–∫–æ–π
  - –°–æ–∑–¥–∞–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –ø–µ—Ä–µ–Ω–æ—Å—É
  - –î–æ–±–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç

#### `ai-handle-event-move`
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–∏—Å—å–º–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
- **–ó–∞–ø—É—Å–∫**: –ü–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∫–Ω–æ–ø–∫–∞ –≤ —á–∞—Ç–µ)
- **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç**:
  - –ü–æ–ª—É—á–∞–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏—è
  - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–∏—Å—å–º–æ —á–µ—Ä–µ–∑ Gmail/Outlook API
  - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è

#### `ai-handle-email-reply`
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç—ã —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- **–ó–∞–ø—É—Å–∫**: –ß–µ—Ä–µ–∑ webhook –æ—Ç Gmail/Outlook
- **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç**:
  - –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —Å –ø–æ–º–æ—â—å—é AI
  - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ –ø—Ä–∏ —Å–æ–≥–ª–∞—Å–∏–∏
  - –£–≤–µ–¥–æ–º–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç–µ

### 3. UI (Chat.tsx)
- –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è AI –≤ –≤–∏–¥–µ –∫–∞—Ä—Ç–æ—á–µ–∫
- –ö–Ω–æ–ø–∫–∞ "–ù–∞–ø–∏—Å–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º" ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç `ai-handle-event-move`
- Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ Supabase subscriptions

---

## üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø—É—Å–∫—É

### –®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Cron Job

–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –≤ Supabase SQL Editor:

\`\`\`sql
-- 1. –í–∫–ª—é—á–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è pg_cron –∏ pg_net
CREATE EXTENSION IF NOT EXISTS pg_cron;
CREATE EXTENSION IF NOT EXISTS pg_net;

-- 2. –°–æ–∑–¥–∞—Ç—å cron job –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ (–∫–∞–∂–¥–æ–µ —É—Ç—Ä–æ –≤ 9:00 UTC)
SELECT cron.schedule(
  'ai-week-planner-daily',
  '0 9 * * *', -- –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 9:00 UTC (12:00 MSK)
  $$
  SELECT
    net.http_post(
      url:='https://pytefsexxwtlropzkmxi.supabase.co/functions/v1/ai-week-planner',
      headers:='{"Content-Type": "application/json", "Authorization": "Bearer YOUR_SERVICE_ROLE_KEY"}'::jsonb,
      body:='{}'::jsonb
    ) as request_id;
  $$
);
\`\`\`

**–í–∞–∂–Ω–æ**: –ó–∞–º–µ–Ω–∏—Ç–µ `YOUR_SERVICE_ROLE_KEY` –Ω–∞ –≤–∞—à Service Role Key –∏–∑ Supabase Dashboard ‚Üí Settings ‚Üí API.

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É Cron

–ß—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –≤—Ä—É—á–Ω—É—é:

\`\`\`bash
curl -X POST https://pytefsexxwtlropzkmxi.supabase.co/functions/v1/ai-week-planner \\
  -H "Authorization: Bearer YOUR_SERVICE_ROLE_KEY" \\
  -H "Content-Type: application/json"
\`\`\`

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ Supabase Dashboard ‚Üí Edge Functions ‚Üí ai-week-planner ‚Üí Logs.

### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Gmail Webhook (–¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤)

#### 3.1 –°–æ–∑–¥–∞—Ç—å Google Cloud Pub/Sub Topic

1. –ü–µ—Ä–µ–π—Ç–∏ –≤ [Google Cloud Console](https://console.cloud.google.com/cloudpubsub)
2. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π Topic: `gmail-notifications`
3. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω–æ–µ –∏–º—è —Ç–æ–ø–∏–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `projects/YOUR_PROJECT/topics/gmail-notifications`)

#### 3.2 –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Gmail Push Notifications

–í—ã–ø–æ–ª–Ω–∏—Ç–µ —á–µ—Ä–µ–∑ Gmail API:

\`\`\`javascript
// –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ webhook
POST https://gmail.googleapis.com/gmail/v1/users/me/watch
{
  "labelIds": ["INBOX"],
  "topicName": "projects/YOUR_PROJECT/topics/gmail-notifications"
}
\`\`\`

#### 3.3 –°–æ–∑–¥–∞—Ç—å Cloud Function –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ Pub/Sub

\`\`\`javascript
// Google Cloud Function
exports.handleGmailWebhook = async (message, context) => {
  const data = Buffer.from(message.data, 'base64').toString();
  const historyId = JSON.parse(data).historyId;
  
  // –ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
  // –í—ã–∑–≤–∞—Ç—å ai-handle-email-reply —á–µ—Ä–µ–∑ fetch
  
  await fetch('https://pytefsexxwtlropzkmxi.supabase.co/functions/v1/ai-handle-email-reply', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer YOUR_SERVICE_ROLE_KEY'
    },
    body: JSON.stringify({
      threadId: extractedThreadId,
      emailBody: extractedBody,
      userId: extractedUserId
    })
  });
};
\`\`\`

### –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Outlook Webhook

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å webhook endpoint –≤ Azure AD
2. –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –ø–∏—Å—å–º–∞—Ö —á–µ—Ä–µ–∑ Microsoft Graph API:

\`\`\`javascript
POST https://graph.microsoft.com/v1.0/subscriptions
{
  "changeType": "created",
  "notificationUrl": "https://pytefsexxwtlropzkmxi.supabase.co/functions/v1/ai-handle-email-reply",
  "resource": "/me/mailFolders('Inbox')/messages",
  "expirationDateTime": "2025-12-31T00:00:00Z",
  "clientState": "secretClientValue"
}
\`\`\`

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ ai-week-planner

\`\`\`bash
curl -X POST https://pytefsexxwtlropzkmxi.supabase.co/functions/v1/ai-week-planner \\
  -H "Authorization: Bearer YOUR_SERVICE_ROLE_KEY"
\`\`\`

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- –í –ª–æ–≥–∞—Ö Edge Function –ø–æ—è–≤—è—Ç—Å—è –∑–∞–ø–∏—Å–∏ –æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö
- –í —Ç–∞–±–ª–∏—Ü–µ `event_move_suggestions` –ø–æ—è–≤—è—Ç—Å—è –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏
- –í —á–∞—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—è–≤—è—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç AI

### –¢–µ—Å—Ç 2: –ü–µ—Ä–µ–Ω–æ—Å —Å–æ–±—ã—Ç–∏—è

1. –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
2. –£–≤–∏–¥–µ—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –ø–µ—Ä–µ–Ω–æ—Å–∞
3. –ù–∞–∂–∞—Ç—å "–ù–∞–ø–∏—Å–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º"
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (—Å—Ç–∞—Ç—É—Å –≤ –ë–î = 'email_sent')

### –¢–µ—Å—Ç 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞

–°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å webhook:

\`\`\`bash
curl -X POST https://pytefsexxwtlropzkmxi.supabase.co/functions/v1/ai-handle-email-reply \\
  -H "Content-Type: application/json" \\
  -d '{
    "threadId": "test-thread-123",
    "emailBody": "–î–∞, –¥–∞–≤–∞–π—Ç–µ –ø–µ—Ä–µ–Ω–µ—Å–µ–º –Ω–∞ —ç—Ç–æ –≤—Ä–µ–º—è",
    "userId": "user-uuid-here"
  }'
\`\`\`

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å Cron Job

\`\`\`sql
SELECT * FROM cron.job WHERE jobname = 'ai-week-planner-daily';
\`\`\`

### –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø—É—Å–∫–∏

\`\`\`sql
SELECT * FROM cron.job_run_details 
WHERE jobid = (SELECT jobid FROM cron.job WHERE jobname = 'ai-week-planner-daily')
ORDER BY start_time DESC
LIMIT 10;
\`\`\`

### –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ Edge Functions

Supabase Dashboard ‚Üí Edge Functions ‚Üí [function name] ‚Üí Logs

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –ò–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞ Cron

\`\`\`sql
-- –ó–∞–ø—É—Å–∫–∞—Ç—å –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 8:00 UTC (11:00 MSK)
SELECT cron.schedule(
  'ai-week-planner-daily',
  '0 8 * * *',
  ...
);
\`\`\`

### –û—Ç–∫–ª—é—á–∏—Ç—å Cron

\`\`\`sql
SELECT cron.unschedule('ai-week-planner-daily');
\`\`\`

---

## üêõ Troubleshooting

### –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –µ—Å—Ç—å:
   - –ó–∞–ø–∏—Å–∏ –≤ `user_cycles`
   - –°–æ–±—ã—Ç–∏—è –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 7 –¥–Ω–µ–π –≤ `events`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ `ai-week-planner`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ OPENAI_API_KEY –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ Supabase Secrets

### –ü–∏—Å—å–º–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –≤ `user_tokens` (provider = 'google' –∏–ª–∏ 'microsoft')
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —É —Å–æ–±—ã—Ç–∏–π –µ—Å—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∏
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ `ai-handle-event-move`

### –û—Ç–≤–µ—Ç—ã –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ webhook –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ Gmail/Outlook
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `email_thread_id` –∑–∞–ø–∏—Å–∞–Ω –≤ `event_move_suggestions`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ `ai-handle-email-reply`

---

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [Supabase Cron Jobs](https://supabase.com/docs/guides/database/extensions/pg_cron)
- [Gmail Push Notifications](https://developers.google.com/gmail/api/guides/push)
- [Microsoft Graph Webhooks](https://learn.microsoft.com/en-us/graph/webhooks)
- [OpenAI API](https://platform.openai.com/docs/api-reference)

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Cron Job (–®–∞–≥ 1)
2. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ (–¢–µ—Å—Ç 1)
3. ‚è≥ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Gmail/Outlook Webhooks (–®–∞–≥ 3-4)
4. ‚è≥ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª (–¢–µ—Å—Ç—ã 2-3)

–£–¥–∞—á–∏! üöÄ
